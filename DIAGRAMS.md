# Architecture Diagram & Flow

## Clean Architecture Layers

```
???????????????????????????????????????????????????????????
?                    API LAYER                            ?
?                                                         ?
?  ????????????????????????????????????????????????????  ?
?  ?  Program.cs                                      ?  ?
?  ?  ?? Services Registration (DI)                  ?  ?
?  ?  ?? Middleware Configuration                    ?  ?
?  ?  ?? app.MapResidenceEndpoints()                 ?  ?
?  ????????????????????????????????????????????????????  ?
?                          ?                              ?
?  ????????????????????????????????????????????????????  ?
?  ?  ResidenceEndpoints.cs (Static Methods)         ?  ?
?  ?  ?? MapGetAll()                                 ?  ?
?  ?  ?? MapGetById()                                ?  ?
?  ?  ?? MapCreate()                                 ?  ?
?  ?  ?? MapUpdate()                                 ?  ?
?  ?  ?? MapDelete()                                 ?  ?
?  ????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????
                          ?
???????????????????????????????????????????????????????????
?              APPLICATION LAYER                          ?
?                                                         ?
?  ????????????????????????????????????????????????????  ?
?  ?  IResidenceService (Interface)                   ?  ?
?  ?  ?? GetAllResidencesAsync()                      ?  ?
?  ?  ?? GetResidenceByIdAsync()                      ?  ?
?  ?  ?? CreateResidenceAsync()                       ?  ?
?  ?  ?? UpdateResidenceAsync()                       ?  ?
?  ?  ?? DeleteResidenceAsync()                       ?  ?
?  ????????????????????????????????????????????????????  ?
?                          ?                              ?
?  ????????????????????????????????????????????????????  ?
?  ?  ResidenceService (Implementation)               ?  ?
?  ?  ?? Business Logic                              ?  ?
?  ?  ?? DTO Mapping                                 ?  ?
?  ?  ?? Calls IResidenceRepository                  ?  ?
?  ????????????????????????????????????????????????????  ?
?                          ?                              ?
?  ????????????????????????????????????????????????????  ?
?  ?  DTOs (Data Transfer Objects)                    ?  ?
?  ?  ?? CreateResidenceDto                           ?  ?
?  ?  ?? UpdateResidenceDto                           ?  ?
?  ?  ?? ResidenceDto                                 ?  ?
?  ????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????
                          ?
???????????????????????????????????????????????????????????
?              DOMAIN LAYER                               ?
?                                                         ?
?  ????????????????????????????????????????????????????  ?
?  ?  IResidenceRepository (Interface)                ?  ?
?  ?  ?? GetAllAsync()                                ?  ?
?  ?  ?? GetByIdAsync()                               ?  ?
?  ?  ?? CreateAsync()                                ?  ?
?  ?  ?? UpdateAsync()                                ?  ?
?  ?  ?? DeleteAsync()                                ?  ?
?  ????????????????????????????????????????????????????  ?
?                          ?                              ?
?  ????????????????????????????????????????????????????  ?
?  ?  Residence Entity                                ?  ?
?  ?  ?? Id                                           ?  ?
?  ?  ?? Name                                         ?  ?
?  ?  ?? Address                                      ?  ?
?  ?  ?? City                                         ?  ?
?  ?  ?? State                                        ?  ?
?  ?  ?? ZipCode                                      ?  ?
?  ?  ?? NumberOfRooms                                ?  ?
?  ?  ?? Price                                        ?  ?
?  ?  ?? Description                                  ?  ?
?  ?  ?? CreatedAt                                    ?  ?
?  ?  ?? UpdatedAt                                    ?  ?
?  ????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????
                          ?
???????????????????????????????????????????????????????????
?           INFRASTRUCTURE LAYER                          ?
?                                                         ?
?  ????????????????????????????????????????????????????  ?
?  ?  ResidenceRepository (Implementation)            ?  ?
?  ?  ?? GetAllAsync()                                ?  ?
?  ?  ?? GetByIdAsync()                               ?  ?
?  ?  ?? CreateAsync()                                ?  ?
?  ?  ?? UpdateAsync()                                ?  ?
?  ?  ?? DeleteAsync()                                ?  ?
?  ????????????????????????????????????????????????????  ?
?                          ?                              ?
?  ????????????????????????????????????????????????????  ?
?  ?  ApplicationDbContext                            ?  ?
?  ?  ?? OnModelCreating()                            ?  ?
?  ?  ?  ?? ApplyConfiguration(new              ?  ?
?  ?  ?     ResidenceConfiguration())           ?  ?
?  ?  ?? DbSet<Residence>                            ?  ?
?  ????????????????????????????????????????????????????  ?
?                          ?                              ?
?  ????????????????????????????????????????????????????  ?
?  ?  ResidenceConfiguration                          ?  ?
?  ?  (IEntityTypeConfiguration<Residence>)           ?  ?
?  ?  ?? HasKey()                                     ?  ?
?  ?  ?? Property Mappings                            ?  ?
?  ?  ?? Constraints (Required, MaxLength)            ?  ?
?  ?  ?? SQL Column Types                             ?  ?
?  ?  ?? Default Values                               ?  ?
?  ?  ?? ToTable("Residences", "dbo")                 ?  ?
?  ????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????
                          ?
???????????????????????????????????????????????????????????
?              SQL SERVER DATABASE                        ?
?                                                         ?
?  ????????????????????????????????????????????????????  ?
?  ?  dbo.Residences Table                            ?  ?
?  ?  ?? Id (int, PK)                                 ?  ?
?  ?  ?? Name (nvarchar(200))                         ?  ?
?  ?  ?? Address (nvarchar(500))                      ?  ?
?  ?  ?? City (nvarchar(100))                         ?  ?
?  ?  ?? State (nvarchar(50))                         ?  ?
?  ?  ?? ZipCode (nvarchar(20))                       ?  ?
?  ?  ?? Description (nvarchar(1000))                 ?  ?
?  ?  ?? NumberOfRooms (int)                          ?  ?
?  ?  ?? Price (decimal(18,2))                        ?  ?
?  ?  ?? CreatedAt (datetime2)                        ?  ?
?  ?  ?? UpdatedAt (datetime2)                        ?  ?
?  ????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????
```

---

## Request/Response Flow

### GET /api/residences

```
???????????????
?   Client    ?
???????????????
       ? HTTP GET /api/residences
       ?
????????????????????????????????
?  ResidenceEndpoints.cs       ?
?  MapGetAll()                 ?
?  GetAllResidences()          ?
????????????????????????????????
       ? IResidenceService
       ?
????????????????????????????????
?  ResidenceService            ?
?  GetAllResidencesAsync()     ?
????????????????????????????????
       ? IResidenceRepository
       ?
????????????????????????????????
?  ResidenceRepository         ?
?  GetAllAsync()               ?
????????????????????????????????
       ? DbSet<Residence>
       ?
????????????????????????????????
?  ApplicationDbContext        ?
?  DbSet<Residence>            ?
????????????????????????????????
       ? LINQ to SQL
       ?
????????????????????????????????
?  SQL Server                  ?
?  SELECT * FROM              ?
?  dbo.Residences              ?
????????????????????????????????
       ? IEnumerable<Residence>
       ?
????????????????????????????????
?  ResidenceService            ?
?  Map to ResidenceDto[]       ?
????????????????????????????????
       ? IResult
       ?
????????????????????????????????
?  ResidenceEndpoints.cs       ?
?  Results.Ok(residences)      ?
????????????????????????????????
       ? JSON Response
       ?
???????????????
?   Client    ?
? 200 OK      ?
? [...]       ?
???????????????
```

---

### POST /api/residences

```
???????????????
?   Client    ?
? {"name":... ?
???????????????
       ? HTTP POST /api/residences
       ?
????????????????????????????????
?  ResidenceEndpoints.cs       ?
?  MapCreate()                 ?
?  CreateResidence()           ?
????????????????????????????????
       ? Validate Input
       ?? Name, Address required?
       ?? NumberOfRooms > 0?
       ?? Price > 0?
       ?
       ?? ? Invalid?
       ?  ?? Results.BadRequest()
       ?
       ?? ? Valid
       ?
????????????????????????????????
?  ResidenceService            ?
?  CreateResidenceAsync()      ?
?  Map Dto to Entity           ?
????????????????????????????????
       ? IResidenceRepository
       ?
????????????????????????????????
?  ResidenceRepository         ?
?  CreateAsync()               ?
?  Set timestamps              ?
?  DbContext.Add()             ?
?  SaveChangesAsync()          ?
????????????????????????????????
       ? EF Core INSERT
       ?
????????????????????????????????
?  SQL Server                  ?
?  INSERT INTO                 ?
?  dbo.Residences ...          ?
????????????????????????????????
       ? Entity with ID
       ?
????????????????????????????????
?  ResidenceService            ?
?  Map to ResidenceDto         ?
????????????????????????????????
       ? IResult
       ?
????????????????????????????????
?  ResidenceEndpoints.cs       ?
?  Results.Created(uri, dto)   ?
????????????????????????????????
       ? JSON Response
       ?
???????????????
?   Client    ?
? 201 Created ?
? Location:   ?
? /api/.../{id}
? {"id":1...} ?
???????????????
```

---

### PUT /api/residences/{id}

```
???????????????
?   Client    ?
? {"name":... ?
???????????????
       ? HTTP PUT /api/residences/1
       ?
????????????????????????????????
?  ResidenceEndpoints.cs       ?
?  MapUpdate()                 ?
?  UpdateResidence()           ?
????????????????????????????????
       ? Validate ID & Input
       ?? ID > 0?
       ?? Name, Address required?
       ?? NumberOfRooms > 0?
       ?
       ?? ? Invalid?
       ?  ?? Results.BadRequest()
       ?
       ?? ? Valid
       ?
????????????????????????????????
?  ResidenceService            ?
?  UpdateResidenceAsync()      ?
?  Get existing entity         ?
?  Update properties           ?
????????????????????????????????
       ? IResidenceRepository
       ?
????????????????????????????????
?  ResidenceRepository         ?
?  UpdateAsync()               ?
?  Set UpdatedAt               ?
?  DbContext.Update()          ?
?  SaveChangesAsync()          ?
????????????????????????????????
       ? EF Core UPDATE
       ?
????????????????????????????????
?  SQL Server                  ?
?  UPDATE dbo.Residences       ?
?  WHERE Id = 1 ...            ?
????????????????????????????????
       ? Entity
       ?
????????????????????????????????
?  ResidenceService            ?
?  Map to ResidenceDto         ?
????????????????????????????????
       ? IResult
       ?
????????????????????????????????
?  ResidenceEndpoints.cs       ?
?  Results.Ok(dto)             ?
????????????????????????????????
       ? JSON Response
       ?
???????????????
?   Client    ?
? 200 OK      ?
? {"id":1...} ?
???????????????
```

---

### DELETE /api/residences/{id}

```
???????????????
?   Client    ?
???????????????
       ? HTTP DELETE /api/residences/1
       ?
????????????????????????????????
?  ResidenceEndpoints.cs       ?
?  MapDelete()                 ?
?  DeleteResidence()           ?
????????????????????????????????
       ? Validate ID
       ?? ID > 0?
       ?
       ?? ? Invalid?
       ?  ?? Results.BadRequest()
       ?
       ?? ? Valid
       ?
????????????????????????????????
?  ResidenceService            ?
?  DeleteResidenceAsync()      ?
????????????????????????????????
       ? IResidenceRepository
       ?
????????????????????????????????
?  ResidenceRepository         ?
?  DeleteAsync()               ?
?  GetByIdAsync()              ?
?  DbContext.Remove()          ?
?  SaveChangesAsync()          ?
????????????????????????????????
       ? EF Core DELETE
       ?
????????????????????????????????
?  SQL Server                  ?
?  DELETE FROM                 ?
?  dbo.Residences              ?
?  WHERE Id = 1                ?
????????????????????????????????
       ? Success/Not Found
       ?
????????????????????????????????
?  ResidenceEndpoints.cs       ?
?  Results.NoContent()         ?
????????????????????????????????
       ? Response
       ?
???????????????
?   Client    ?
? 204 No Cont.?
???????????????
```

---

## Dependency Injection Flow

```
????????????????????????????????????????????????
?  Program.cs - Service Registration           ?
????????????????????????????????????????????????
         ?
         ?? AddInfrastructureServices()
         ?  ?? AddDbContext<ApplicationDbContext>
         ?  ?? AddScoped<IResidenceRepository, ResidenceRepository>
         ?
         ?? AddApplicationServices()
         ?  ?? AddScoped<IResidenceService, ResidenceService>
         ?
         ?? AddSwaggerGen(), AddCors(), etc.

         ?

????????????????????????????????????????????????
?  Request arrives at endpoint                 ?
????????????????????????????????????????????????
         ?
         ?

????????????????????????????????????????????????
?  DI Container resolves dependencies          ?
????????????????????????????????????????????????
         ?
         ?? Endpoint handler needs
         ?  ?? IResidenceService
         ?     ?? Needs IResidenceRepository
         ?     ?  ?? Needs ApplicationDbContext
         ?     ?     ?? Needs DbContextOptions<ApplicationDbContext>
         ?     ?        ?? Configured in AddDbContext()
         ?     ?? Configured in AddApplicationServices()
         ?
         ?? Create instance chain:
         ?  ?? DbContext ? Repository ? Service ? Handler
         ?
         ?? Inject into handler method

         ?

????????????????????????????????????????????????
?  Handler executes with all dependencies      ?
????????????????????????????????????????????????
```

---

## Entity Configuration Flow

```
???????????????????????????????????????????????
?  ApplicationDbContext.OnModelCreating()     ?
???????????????????????????????????????????????
         ?
         ?? modelBuilder.ApplyConfiguration(
         ?    new ResidenceConfiguration()
         ?  )
         ?
         ?

???????????????????????????????????????????????
?  ResidenceConfiguration.Configure()         ?
?  (IEntityTypeConfiguration<Residence>)      ?
???????????????????????????????????????????????
         ?
         ?? builder.HasKey(e => e.Id)
         ?  ?? Maps to PK in database
         ?
         ?? builder.Property(e => e.Name)
         ?  ?? .IsRequired()          ? NOT NULL
         ?  ?? .HasMaxLength(200)     ? nvarchar(200)
         ?  ?? .HasColumnType(...)    ? Exact SQL type
         ?
         ?? builder.Property(e => e.Price)
         ?  ?? .HasColumnType("decimal(18,2)")
         ?  ?? .HasPrecision(18, 2)
         ?
         ?? builder.Property(e => e.CreatedAt)
         ?  ?? .HasDefaultValueSql("GETUTCDATE()")
         ?  ?? Auto-populated by database
         ?
         ?? builder.ToTable("Residences", "dbo")
            ?? Maps to dbo.Residences in database

         ?

???????????????????????????????????????????????
?  EF Core generates migration/script         ?
???????????????????????????????????????????????
         ?
         ?

???????????????????????????????????????????????
?  SQL Server executes DDL                    ?
?  CREATE TABLE dbo.Residences (              ?
?    Id int PRIMARY KEY IDENTITY,             ?
?    Name nvarchar(200) NOT NULL,             ?
?    ...                                      ?
?  )                                          ?
???????????????????????????????????????????????
```

---

## MapEndpoints Organization

```
ResidenceEndpoints.cs
?
?? MapResidenceEndpoints()
?  (Public entry point)
?  ?
?  ?? Create RouteGroupBuilder
?  ?  ?? /api/residences
?  ?
?  ?? Call MapGetAll()
?  ?? Call MapGetById()
?  ?? Call MapCreate()
?  ?? Call MapUpdate()
?  ?? Call MapDelete()
?
?? MapGetAll()
?  ?? MapGet("/", GetAllResidences)
?     ?? WithName()
?     ?? WithOpenApi()
?     ?? WithSummary()
?     ?? Produces()
?
?? MapGetById()
?  ?? MapGet("/{id}", GetResidenceById)
?     ?? ...metadata...
?
?? MapCreate()
?  ?? MapPost("/", CreateResidence)
?     ?? ...metadata...
?
?? MapUpdate()
?  ?? MapPut("/{id}", UpdateResidence)
?     ?? ...metadata...
?
?? MapDelete()
?  ?? MapDelete("/{id}", DeleteResidence)
?     ?? ...metadata...
?
?? GetAllResidences() [Handler]
?? GetResidenceById() [Handler]
?? CreateResidence() [Handler]
?? UpdateResidence() [Handler]
?? DeleteResidence() [Handler]
?
?? ValidateCreateDto() [Helper]
   ?? ValidateUpdateDto() [Helper]
```

---

This architecture ensures:
- ? **Separation of Concerns** - Each layer has specific responsibility
- ? **Dependency Inversion** - Depends on abstractions, not implementations
- ? **Testability** - Each layer can be tested independently
- ? **Maintainability** - Clear structure and organization
- ? **Scalability** - Easy to add new entities and endpoints
